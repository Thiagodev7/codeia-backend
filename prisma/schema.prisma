// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE DO SAAS ---

model Tenant {
  id            String   @id @default(uuid())
  name          String
  document      String   @unique
  plan          String   @default("FREE")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users         User[]
  agents        Agent[]
  customers     Customer[]
  
  // CORREÇÃO 1: Mudou de 'waSession WhatsAppSession?' para um array (1:N)
  waSessions    WhatsAppSession[] 
  
  messages      Message[]
  appointments  Appointment[]
  services      Service[]

  @@map("tenants")
}

model User {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  email         String   @unique
  phone         String?
  passwordHash  String
  role          String   @default("ADMIN")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  @@map("users")
}

// --- MODULO DE IA ---

model Agent {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  slug          String
  model         String   @default("gemini-1.5-flash")
  instructions  String   @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  // CORREÇÃO 2: Adicionado o campo oposto da relação com as sessões
  waSessions    WhatsAppSession[]

  @@unique([tenantId, slug])
  @@map("agents")
}

// --- MÓDULO WHATSAPP (BAILEYS ENGINE) ---

model WhatsAppSession {
  id            String   @id @default(uuid())
  tenantId      String
  sessionName   String   @default("Principal")
  status        String   @default("DISCONNECTED")
  
  // Relação com as chaves de autenticação (Segurança)
  authKeys      WhatsAppAuthKey[]

  agentId       String?
  agent         Agent?   @relation(fields: [agentId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("whatsapp_sessions")
}

model WhatsAppAuthKey {
  id          String   @id @default(uuid())
  sessionId   String
  keyId       String   // Identificador da chave (ex: "creds", "sender-key-xyz")
  type        String   // Categoria da chave
  value       Json     // Valor criptografado (Buffer serializado)
  
  session     WhatsAppSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, keyId]) // Garante que não duplicamos chaves
  @@map("whatsapp_auth_keys")
}

model Customer {
  id            String   @id @default(uuid())
  tenantId      String
  phone         String
  name          String?
  createdAt     DateTime @default(now())

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  messages      Message[]
  appointments  Appointment[]

  @@unique([tenantId, phone])
  @@map("customers")
}

model Message {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String
  role          String   // 'user' ou 'model'
  content       String   @db.Text
  createdAt     DateTime @default(now())

  customer      Customer @relation(fields: [customerId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("messages")
}

// --- MODULO DE AGENDA ---

model Service {
  id            String   @id @default(uuid())
  tenantId      String
  name          String   
  description   String?  
  price         Decimal  @default(0.0) 
  duration      Int      
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  appointments  Appointment[]

  @@map("services")
}

model Appointment {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String
  serviceId     String?
  
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  status        String   @default("SCHEDULED")
  
  customer      Customer @relation(fields: [customerId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  service       Service? @relation(fields: [serviceId], references: [id])

  @@map("appointments")
}