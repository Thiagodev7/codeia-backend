// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE DO SAAS ---

model Tenant {
  id            String   @id @default(uuid())
  name          String
  document      String   @unique
  plan          String   @default("FREE")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relacionamentos
  users         User[]
  agents        Agent[]
  customers     Customer[]
  waSessions    WhatsAppSession[]
  messages      Message[]
  appointments  Appointment[]
  services      Service[]

  // [NOVO] Configurações da Empresa (1:1)
  settings      TenantSettings?

  @@map("tenants")
}

model User {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  email         String   @unique
  phone         String?
  passwordHash  String
  role          String   @default("ADMIN") // 'ADMIN' ou 'AGENT'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  // [NOVO] Preferências do Usuário (1:1)
  settings      UserSettings?

  @@map("users")
}

// --- MÓDULO DE IA ---

model Agent {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  slug          String
  model         String   @default("gemini-2.0-flash-lite")
  instructions  String   @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  waSessions    WhatsAppSession[]

  @@unique([tenantId, slug])
  @@map("agents")
}

// --- MÓDULO WHATSAPP (BAILEYS ENGINE) ---

model WhatsAppSession {
  id            String   @id @default(uuid())
  tenantId      String
  sessionName   String   @default("Principal")
  status        String   @default("DISCONNECTED")
  
  authKeys      WhatsAppAuthKey[]

  agentId       String?
  agent         Agent?   @relation(fields: [agentId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("whatsapp_sessions")
}

model WhatsAppAuthKey {
  id          String   @id @default(uuid())
  sessionId   String
  keyId       String   
  type        String   
  value       Json     
  
  session     WhatsAppSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, keyId])
  @@map("whatsapp_auth_keys")
}

// --- CRM & ATENDIMENTO ---

model Customer {
  id            String   @id @default(uuid())
  tenantId      String
  phone         String
  name          String?
  createdAt     DateTime @default(now())

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  messages      Message[]
  appointments  Appointment[]

  @@unique([tenantId, phone])
  @@map("customers")
}

model Message {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String
  role          String   // 'user' ou 'model'
  content       String   @db.Text
  createdAt     DateTime @default(now())

  customer      Customer @relation(fields: [customerId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("messages")
}

// --- MÓDULO DE AGENDA ---

model Service {
  id            String   @id @default(uuid())
  tenantId      String
  name          String   
  description   String?
  price         Decimal  @default(0.0) 
  duration      Int      
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  appointments  Appointment[]

  @@map("services")
}

model Appointment {
  id            String   @id @default(uuid())
  tenantId      String
  customerId    String
  serviceId     String?
  
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  status        String   @default("SCHEDULED")
  
  customer      Customer @relation(fields: [customerId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  service       Service? @relation(fields: [serviceId], references: [id])

  @@map("appointments")
}

// --- [NOVO] TABELAS DE CONFIGURAÇÃO ---

model TenantSettings {
  id            String   @id @default(uuid())
  tenantId      String   @unique
  
  // Identidade
  primaryColor  String   @default("#06b6d4")
  logoUrl       String?
  
  // [NOVOS CAMPOS] - A IA precisa disso!
  businessName  String?
  description   String?  @db.Text
  address       String?
  contactPhone  String?
  website       String?
  
  // Negócio
  timezone      String   @default("America/Sao_Paulo")
  currency      String   @default("BRL")
  businessHours Json?    
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model UserSettings {
  id            String   @id @default(uuid())
  userId        String   @unique // Relação 1:1 obrigatória
  
  // Preferências de Interface
  theme         String   @default("system") // light, dark, system
  language      String   @default("pt-BR")
  
  // Preferências de Notificação
  emailAlerts   Boolean  @default(true)
  whatsappAlerts Boolean @default(true)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}